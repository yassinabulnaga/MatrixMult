module fifo_wrapper #(parameter int W=16, LGFLEN=7)(
  input  logic         clk,
  input  logic         rst_n,
  input  logic [W-1:0] s_data,
  input  logic         s_valid,
  output logic         s_ready,
  output logic [W-1:0] m_data,
  output logic         m_valid,
  input  logic         m_ready
);

  logic full, empty;
  logic [W-1:0] fifo_dout;

  assign s_ready = !full;

  wire do_wr = s_valid && s_ready;
  
  // Read from internal FIFO
  logic fifo_read;
  
  sfifo #(
    .BW(W),
    .LGFLEN(LGFLEN),
    .OPT_ASYNC_READ    (1'b1),
    .OPT_WRITE_ON_FULL (1'b0),
    .OPT_READ_ON_EMPTY (1'b0)
  ) u (
    .i_clk   (clk),
    .i_reset (!rst_n),
    .i_wr    (do_wr),
    .i_data  (s_data),
    .o_full  (full),
    .o_fill  (),
    .i_rd    (fifo_read),
    .o_data  (fifo_dout),
    .o_empty (empty)
  );

  // Output stage with skid buffer
  logic [W-1:0] out_data_q;
  logic out_valid_q;
  logic [W-1:0] skid_data_q;
  logic skid_valid_q;

  assign m_data = out_data_q;
  assign m_valid = out_valid_q;
  
  // Read when we have room in output stage
  assign fifo_read = !empty && (!out_valid_q || (m_ready && !skid_valid_q));

  always_ff @(posedge clk or negedge rst_n) begin
    if (!rst_n) begin
      out_data_q <= '0;
      out_valid_q <= 1'b0;
      skid_data_q <= '0;
      skid_valid_q <= 1'b0;
    end else begin
      
      // Handle main output register
      if (out_valid_q && m_ready) begin
        // Output accepted
        if (skid_valid_q) begin
          // Move skid to output
          out_data_q <= skid_data_q;
          out_valid_q <= 1'b1;
          skid_valid_q <= 1'b0;
        end else if (!empty) begin
          // Refill from FIFO (fifo_read asserted)
          out_data_q <= fifo_dout;
          out_valid_q <= 1'b1;
        end else begin
          out_valid_q <= 1'b0;
        end
      end else if (!out_valid_q && !empty) begin
        // Output empty, load from FIFO (fifo_read asserted)
        out_data_q <= fifo_dout;
        out_valid_q <= 1'b1;
      end
      
      // Handle skid buffer - capture FIFO data when output is stalled
      if (fifo_read && out_valid_q && !m_ready && !skid_valid_q) begin
        skid_data_q <= fifo_dout;
        skid_valid_q <= 1'b1;
      end else if (skid_valid_q && m_ready) begin
        // Skid consumed (moved to output above)
        skid_valid_q <= 1'b0;
      end
      
    end
  end

endmodule
